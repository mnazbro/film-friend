# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Film Friend is a Capacitor-based mobile application (iOS/Android) built with React, TypeScript, and Vite. It's a tool for film photographers to track their cameras, film rolls, and frames.

## Core Technologies

- **Framework**: React 19 with TypeScript
- **State Management**: Redux Toolkit with typed hooks
- **UI Library**: Material-UI (MUI) v7 with Emotion for styling
- **Forms**: TanStack Form with Zod validation
- **Routing**: TanStack Router with file-based routing
- **Mobile Platform**: Capacitor 7 (iOS & Android)
- **Build Tool**: Vite with TanStack Router plugin and legacy plugin
- **Testing**: Vitest with React Testing Library
- **Date Handling**: date-fns for operations, MUI X Date Pickers for UI
- **Notifications**: Notistack for toast notifications

## Development Commands

```bash
# Start development server (accessible on local network)
pnpm dev

# Build for production (runs TypeScript check first)
pnpm build

# Run tests
pnpm test

# Run tests in watch mode
pnpm test --watch

# Lint (TypeScript check + Prettier check + ESLint)
pnpm lint

# Format code
pnpm format

# Preview production build
pnpm preview
```

### Capacitor Commands

```bash
# Sync web assets to native projects
npx cap sync

# Open in Xcode (iOS)
npx cap open ios

# Open in Android Studio
npx cap open android

# Run on iOS
npx cap run ios

# Run on Android
npx cap run android
```

## Architecture

### State Management

The app uses Redux Toolkit with three slices:

1. **`cameraSlice`** (`src/store/cameraSlice.ts`): Manages cameras, film rolls, and frames
   - Camera actions: `addCamera`, `updateCamera`, `deleteCamera`, `hideCameraCamera`
   - Roll actions: `addRoll`, `updateRoll`, `deleteRoll`, `hideRoll`
   - Frame actions: `addFrame`, `updateFrame`, `deleteFrame`
   - Stores camera metadata (shutter speeds, light meter, film format) and nested roll/frame data

2. **`activeSlice`** (`src/store/activeSlice.ts`): Tracks currently active camera and roll
   - Actions: `setActiveCamera`, `setActiveRoll`
   - Used for navigation and context

3. **`appSlice`** (`src/store/appSlice.ts`): Global app settings
   - Actions: `setDarkMode`

**Redux State Structure:**

```
RootState
├── app: AppState
│   └── isDarkMode: boolean
├── active: ActiveState
│   ├── cameraId: CameraId | null
│   └── rollId: RollId | null
└── camera: CameraState
    └── cameras: Camera[]
```

**Selectors** are located in `src/selectors/` and use `createAppSelector` from the store for type safety. Examples:

- `selectActiveCamera`: Finds the active camera by joining active.cameraId with camera.cameras
- `selectActiveRoll`: Finds the active roll within the active camera
- `selectAtLeastOneCameraExists`: Boolean check for onboarding flow
- `selectVisibleCameras`: Filters cameras where visible is true

### Data Model

Core types are defined in `src/types.ts` using Zod schemas for runtime validation:

- **Camera**: Contains name, film format, shutter speeds, light meter info, visible flag, and an array of rolls
- **Roll**: Film roll with ISO, frame count, load date, shotAtIso (optional), visible flag, and an array of frames
- **Frame**: Individual frame data with optional aperture (number), shutterSpeed (number), date (ISO datetime string), location, link (URL), and notes

ID types are branded strings (Zod template literal schemas):

- `CameraId`: `camera_${string}`
- `RollId`: `roll_${string}`

Film formats: `"35mm"`, `"120"`, `"polaroid"`

ISO values: `"25"`, `"50"`, `"80"`, `"100"`, `"160"`, `"200"`, `"400"`, `"800"`, `"1600"`, `"3200"`, `"6400"`

### Routing Structure

The app uses **TanStack Router** with file-based routing. Route files are located in `src/routes/`:

- `src/routes/index.tsx` - Home page (shows onboarding or active camera/roll)
- `src/routes/flash.tsx` - Flash calculator page
- `src/routes/camera/index.tsx` - Camera list page
- `src/routes/camera/select.tsx` - Camera selection page
- `src/routes/camera/new.tsx` - Create new camera
- `src/routes/camera/$cameraId/index.tsx` - Camera detail page
- `src/routes/camera/$cameraId/roll/new.tsx` - Create new roll for camera
- `src/routes/camera/$cameraId/roll/$rollId.tsx` - Roll detail page
- `src/routes/settings.tsx` - App settings

**Router configuration:**

- Router instance created in `src/router.tsx` using `createRouter`
- Route tree auto-generated by TanStack Router plugin at `src/routeTree.gen.ts` (don't edit manually)
- `RouterProvider` wraps the app in `src/App.tsx`
- All pages are wrapped in `PageWrapper` component which handles navigation
- Route params accessed via `useParams({ from: "/route/path" })` hook

**Capacitor back button:**

- Native back button handler in `src/main.tsx` uses `router.history.back()` for navigation

### Component Patterns

- **Form Components**: Custom form wrapper at `src/components/form/Form.tsx` provides `useAppForm` hook
  - Form fields accessed via `form.AppField` component with render prop pattern
  - Field components: `field.TextInput`, `field.NumberInput`, `field.NumericInput`, `field.BooleanInput`, `field.DatePickerInput`, `field.DateTimePickerInput`, `field.SubmitButton`
  - All field components automatically bound to field state
- **Typed Hooks**: Use `useAppSelector` and `useAppDispatch` from `src/hooks/redux.ts` instead of raw Redux hooks for type safety
- **Navigation**:
  - Use `RouterLink` component (wrapper around TanStack Router's Link) for internal navigation
  - Use `useNavigate` from `@tanstack/react-router` for programmatic navigation with `navigate({ to: "/path" })`
- **Page Structure**: Pages render different screens conditionally based on state (see HomePage.tsx for pattern)
- **Safe Area Insets**: Use `PageWrapper` which handles mobile safe areas (notches, home indicators) via CSS env variables

### Forms and Validation

- Forms use **TanStack Form** with Zod validation
- Custom hook `useAppForm` from `src/components/form/Form.tsx` wraps TanStack Form with app-specific patterns
- Validation can be done:
  - At form level via `validators.onChange` in `useAppForm` config (pass a Zod schema)
  - At field level via `validators.onChange` in `form.AppField`
- Form components use render prop pattern for type-safe field binding
- Example:

  ```tsx
  const form = useAppForm({
    defaultValues: { name: "" },
    validators: { onChange: z.object({ name: z.string().min(1) }) },
    onSubmit: ({ value }) => {
      /* submit logic */
    },
  });

  <form.AppForm>
    <form.AppField name="name">{(field) => <field.TextInput label="Name" />}</form.AppField>
    <form.SubmitButton>Submit</form.SubmitButton>
  </form.AppForm>;
  ```

### DevTools

Development environment includes:

- **TanStack Router DevTools**: Rendered inside `App.tsx` with `<TanStackRouterDevtools router={router} />`
- **TanStack Form DevTools**: Integrated via `TanStackDevtools` with `FormDevtoolsPlugin` in `src/main.tsx`
- **Redux DevTools**: Store is compatible with Redux DevTools browser extension
- DevTools are only included in development builds

## Code Style

The project has strict ESLint configuration:

- **Import Order**: Alphabetically sorted, no blank lines between import groups
- **Sort Imports**: Members within imports are sorted
- **Padding**: Blank line required after block-like statements
- **Type Safety**: TypeScript strict mode with recommended type-checked rules
- **Semicolons**: Required
- **Unused Vars**: Prefix with `_` to ignore
- **React**: No need to import React in JSX files (React 17+ transform)
- **Formatting**: Prettier is used for code formatting

Run `pnpm lint` before committing to catch issues.

## Testing

Tests use Vitest with jsdom environment configured in `vite.config.ts`:

- Setup file: `src/setupTests.ts`
- Timezone: UTC (for consistent date handling)
- Mocks are automatically cleared, reset, and restored between tests
- Run with: `pnpm test` (or `pnpm test --watch` for watch mode)

## Mobile-Specific Considerations

- The app uses Capacitor plugins for native functionality:
  - `@capacitor/app` - Back button handling
  - `@capacitor/camera` - Camera access
  - `@capacitor/haptics` - Haptic feedback
  - `@capacitor/keyboard` - Keyboard events (resize mode: "body" in capacitor.config.ts)
  - `@capacitor/preferences` - Local storage
  - `@capacitor/status-bar` - Status bar control
- iOS scheme: `FilmFriendApp`
- Android scheme: `https`
- Web assets build to `dist/` directory
- Native back button integration uses TanStack Router's history API in `src/main.tsx`
- Safe area insets handled via CSS `env(safe-area-inset-*)` variables in `PageWrapper`
- Notifications positioned above safe area using Notistack's `anchorOrigin` prop

## State Persistence

The app persists Redux state to device storage using `CapacitorStorageService` (`src/services/storage.ts`):

- **Native platforms**: Uses Capacitor Filesystem API to write state as JSON to app's Data directory
- **Web platform**: Falls back to localStorage
- State is automatically saved on changes and loaded on app startup
- All state (cameras, rolls, frames, settings) is stored locally with no backend

## Important Notes

- Film formats supported: 35mm, 120, polaroid
- ISO values are predefined in types.ts (25-6400)
- Cameras can be hidden/archived via the `visible` property (same for rolls)
- The app is designed for offline-first usage
- Route tree file (`src/routeTree.gen.ts`) is auto-generated by Vite plugin - do not edit manually
- Package manager: pnpm (enforced via preinstall script)
